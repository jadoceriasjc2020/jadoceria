<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Calculadora — Dinheiro na Internet</title>
  <style>
    body { font-family: Inter, system-ui, Arial; margin: 0; padding: 20px; background:#f7f7f8; color:#222; }
    header { display:flex; justify-content:space-between; align-items:center; margin-bottom:20px; }
    .brand { font-weight:700; font-size:18px; }
    .card { background:#fff; padding:18px; border-radius:10px; box-shadow:0 6px 18px rgba(30,30,30,0.06); margin-bottom:16px; }
    .hidden { display:none; }
    .plans { display:flex; gap:12px; flex-wrap:wrap; }
    .plan { flex:1 1 220px; padding:14px; border-radius:8px; border:1px solid #e6e6e9; text-align:center; }
    .plan h3 { margin:0 0 8px 0; }
    button { background:#111; color:white; border:0; padding:10px 14px; border-radius:6px; cursor:pointer; }
    .secondary { background:#f0f0f3; color:#111; }
    #paymentStatus { margin-top:10px; color:#b00; }
    .top-actions { display:flex; gap:8px; align-items:center; }
    .small { font-size:13px; color:#666; }
    label { display:block; margin:8px 0 4px; font-weight:600; }
    input[type=number] { width:100%; padding:8px; border-radius:6px; border:1px solid #ddd; }
  </style>
  <!-- Netlify Identity widget -->
  <script src="https://identity.netlify.com/v1/netlify-identity-widget.js"></script>
</head>
<body>
  <header>
    <div class="brand">Dinheiro na Internet — Calculadora</div>
    <div class="top-actions">
      <div id="userInfo" class="small">Não autenticado</div>
      <button id="btnLogin" class="secondary">Entrar / Registrar</button>
      <button id="btnLogout" class="hidden">Sair</button>
    </div>
  </header>

  <!-- Área principal -->
  <main>
    <!-- Mensagem breve -->
    <section class="card">
      <strong>Uso:</strong> se você tem a role <code>premium</code>, verá a calculadora. Caso contrário, verá os planos disponíveis.
    </section>

    <!-- Área da Calculadora (apenas para premium) -->
    <section id="calculatorSection" class="card hidden">
      <h2>Calculadora de Precificação</h2>
      <div>
        <label for="cost">Custo (R$)</label>
        <input id="cost" type="number" step="0.01" value="50">
        <label for="markup">Markup (%)</label>
        <input id="markup" type="number" step="0.01" value="30">
        <label for="quantity">Quantidade prevista por mês</label>
        <input id="quantity" type="number" step="1" value="100">
        <div style="margin-top:10px;">
          <button id="calcBtn">Calcular</button>
        </div>
        <div id="result" style="margin-top:12px;" class="small"></div>
      </div>
    </section>

    <!-- Área dos Planos (padrão para não-premium) -->
    <section id="plansSection" class="card hidden">
      <h2>Escolha um plano</h2>
      <div class="plans">
        <div class="plan">
          <h3>Mensal</h3>
          <p class="small">R$ — renovação mensal</p>
          <button class="subscribeBtn" data-price-id="price_1SCuGt02L39AfqKm9PqFGDLu" data-mode="subscription">Assinar Mensal</button>
        </div>

        <div class="plan">
          <h3>Anual</h3>
          <p class="small">Melhor custo-benefício</p>
          <button class="subscribeBtn" data-price-id="price_1SCuK802L39AfqKmG5cnTMmO" data-mode="subscription">Assinar Anual</button>
        </div>

        <div class="plan">
          <h3>Vitalício</h3>
          <p class="small">Pagamento único</p>
          <button class="subscribeBtn" data-price-id="price_1SCuLC02L39AfqKm5xsl4G96" data-mode="payment">Comprar Vitalício</button>
        </div>
      </div>

      <div id="paymentStatus" class="small"></div>
    </section>

  </main>

  <script>
    // Inicializa Netlify Identity
    const netlifyIdentity = window.netlifyIdentity;
    netlifyIdentity.init();

    // Elementos DOM
    const btnLogin = document.getElementById('btnLogin');
    const btnLogout = document.getElementById('btnLogout');
    const userInfo = document.getElementById('userInfo');
    const calculatorSection = document.getElementById('calculatorSection');
    const plansSection = document.getElementById('plansSection');
    const paymentStatus = document.getElementById('paymentStatus');

    // Função utilitária para pegar o user object de forma segura
    function getCurrentUser() {
      try {
        const user = netlifyIdentity.currentUser();
        if (!user) return null;
        // Em algumas versões a estrutura é user.id ou user.sub; adaptamos
        const id = user.id || (user.user_metadata && user.user_metadata.id) || (user.sub);
        return Object.assign({}, user, { id });
      } catch (err) {
        return null;
      }
    }

    // Verifica se o usuário tem a role 'premium'
    function userIsPremium(user) {
      if (!user) return false;
      // tentar app_metadata.roles, ou roles diretamente
      const roles = (user.app_metadata && user.app_metadata.roles) || user.roles || [];
      return Array.isArray(roles) && roles.includes('premium');
    }

    // Atualiza UI conforme usuário/logged state/roles
    function refreshUI() {
      const user = getCurrentUser();
      if (user) {
        userInfo.textContent = `Olá, ${user.user_metadata && user.user_metadata.full_name ? user.user_metadata.full_name : (user.email || user.id)}`;
        btnLogin.classList.add('hidden');
        btnLogout.classList.remove('hidden');
      } else {
        userInfo.textContent = 'Não autenticado';
        btnLogin.classList.remove('hidden');
        btnLogout.classList.add('hidden');
      }

      // Mostrar calculadora apenas se premium
      if (user && userIsPremium(user)) {
        calculatorSection.classList.remove('hidden');
        plansSection.classList.add('hidden');
      } else {
        calculatorSection.classList.add('hidden');
        plansSection.classList.remove('hidden');
      }
    }

    // Event listeners Netlify Identity
    netlifyIdentity.on('login', () => {
      netlifyIdentity.close();
      refreshUI();
    });
    netlifyIdentity.on('logout', () => {
      refreshUI();
    });

    // Login / Logout buttons
    btnLogin.addEventListener('click', () => netlifyIdentity.open());
    btnLogout.addEventListener('click', () => netlifyIdentity.logout());

    // Inicializa a UI ao carregar
    refreshUI();

    // --- Calculadora simples ---
    document.getElementById('calcBtn').addEventListener('click', () => {
      const cost = parseFloat(document.getElementById('cost').value) || 0;
      const markup = parseFloat(document.getElementById('markup').value) || 0;
      const qty = parseInt(document.getElementById('quantity').value) || 0;
      const price = cost + (cost * (markup / 100));
      const revenue = price * qty;
      const profit = (price - cost) * qty;
      document.getElementById('result').innerHTML = `
        Preço sugerido: R$ ${price.toFixed(2)} <br>
        Receita mensal: R$ ${revenue.toFixed(2)} <br>
        Lucro mensal estimado: R$ ${profit.toFixed(2)}
      `;
    });

    // --- Checkout (consome sua função Netlify create-checkout-session) ---
    // Seleciona todos os botões com classe subscribeBtn
    const subscribeButtons = Array.from(document.querySelectorAll('.subscribeBtn'));

    // Função utilitária de sleep
    const wait = ms => new Promise(res => setTimeout(res, ms));

    subscribeButtons.forEach(button => {
      button.addEventListener('click', async (e) => {
        paymentStatus.textContent = '';
        const priceId = e.currentTarget.dataset.priceId;
        const mode = e.currentTarget.dataset.mode;

        if (!priceId || !mode) {
          paymentStatus.textContent = 'Erro interno: priceId ou mode ausente.';
          return;
        }

        paymentStatus.textContent = 'A gerar link de pagamento...';

        try {
          // garantir que o usuário está logado (precisa do userId)
          let user = getCurrentUser();

          if (!user) {
            // abre modal de login, espera até que o usuário faça login (ou timeout)
            netlifyIdentity.open();
            // aguardar login com timeout simples (20s)
            let waited = 0;
            while (!user && waited < 20000) {
              await wait(500);
              waited += 500;
              user = getCurrentUser();
            }
          }

          if (!user) {
            paymentStatus.textContent = 'Você precisa estar logado para assinar.';
            return;
          }

          const userId = user.id || user.sub || (user.user_metadata && user.user_metadata.id);
          if (!userId) {
            paymentStatus.textContent = 'ID do usuário não encontrado. Tente relogar.';
            return;
          }

          // Faz a requisição à função - envia JSON e espera redirect_url
          const response = await fetch('/.netlify/functions/create-checkout-session', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json'
            },
            body: JSON.stringify({ priceId, mode, userId })
          });

          // Lê JSON uma única vez
          const data = await response.json().catch(() => ({}));

          if (!response.ok) {
            const errMsg = (data && data.error) ? data.error : `Erro ${response.status}`;
            paymentStatus.textContent = `Erro ao criar sessão: ${errMsg}`;
            console.error('create-checkout-session erro:', response.status, data);
            return;
          }

          if (!data.redirect_url) {
            paymentStatus.textContent = 'Resposta inválida do servidor, sem redirect_url.';
            console.error('Resposta sem redirect_url:', data);
            return;
          }

          // Redireciona para o Stripe Checkout
          paymentStatus.textContent = 'Redirecionando para o pagamento...';
          window.location.href = data.redirect_url;

        } catch (err) {
          console.error('Erro no checkout:', err);
          paymentStatus.textContent = `Erro: ${err && err.message ? err.message : err}`;
        }
      });
    });

    // Atualiza a UI caso o usuário já esteja logado quando a página carrega
    // (em situações de SPA, netlifyIdentity.currentUser() pode surgir depois)
    setTimeout(refreshUI, 800);

  </script>
</body>
</html>
